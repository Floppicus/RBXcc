"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("events"),e=require("net"),n=require("dgram"),o=require("buffer");function r(t,e){return(r=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}exports.default=function(c){var i,a;function u(r,i,a,u){var s;return(s=c.call(this)||this).send=function(t,e,n){var r;if(s.tcp){e=e||2,n=n||s.rconId;var c=o.Buffer.byteLength(t);(r=o.Buffer.alloc(c+14)).writeInt32LE(c+10,0),r.writeInt32LE(n,4),r.writeInt32LE(e,8),r.write(t,12),r.writeInt16LE(0,c+12)}else{if(s.challenge&&!s._challengeToken)return void s.emit("error",new Error("Not authenticated"));var i="rcon ";s._challengeToken&&(i+=s._challengeToken+" "),s.password&&(i+=s.password+" "),(r=o.Buffer.alloc(4+o.Buffer.byteLength(i+=t+"\n"))).writeInt32LE(-1,0),r.write(i,4)}s._sendSocket(r)},s._sendSocket=function(t){s._tcpSocket?s._tcpSocket.write(t.toString("binary"),"binary"):s._udpSocket&&s._udpSocket.send(t,0,t.length,s.port,s.host)},s.connect=function(){s.tcp?(s._tcpSocket=e.createConnection(s.port,s.host),s._tcpSocket.on("data",(function(t){s._tcpSocketOnData(t)})).on("connect",(function(){s.socketOnConnect()})).on("error",(function(t){s.emit("error",t)})).on("end",(function(){s.socketOnEnd()}))):(s._udpSocket=n.createSocket("udp4"),s._udpSocket.on("message",(function(t){s._udpSocketOnData(t)})).on("listening",(function(){s.socketOnConnect()})).on("error",(function(t){s.emit("error",t)})).on("close",(function(){s.socketOnEnd()})),s._udpSocket.bind(0))},s.disconnect=function(){s._tcpSocket&&s._tcpSocket.end(),s._udpSocket&&s._udpSocket.close()},s.setTimeout=function(t,e){s._tcpSocket&&s._tcpSocket.setTimeout(t,(function(){s._tcpSocket.end(),e&&e()}))},s._udpSocketOnData=function(t){if(4294967295===t.readUInt32LE(0)){var e=t.toString("utf-8",4),n=e.split(" ");3===n.length&&"challenge"===n[0]&&"rcon"===n[1]?(s._challengeToken=n[2].substr(0,n[2].length-1).trim(),s.hasAuthed=!0,s.emit("auth")):s.emit("response",e.substr(1,e.length-2))}else s.emit("error",new Error("Received malformed packet"))},s._tcpSocketOnData=function(t){for(null!=s.outstandingData&&(t=o.Buffer.concat([s.outstandingData,t],s.outstandingData.length+t.length),s.outstandingData=null);t.length;){var e=t.readInt32LE(0);if(!e)return;var n=t.readInt32LE(4),r=t.readInt32LE(8);if(!(e>=10&&t.length>=e+4)){s.outstandingData=t;break}if(n===s.rconId)if(s.hasAuthed||2!==r){if(0===r){var c=t.toString("utf8",12,12+e-10);"\n"===c.charAt(c.length-1)&&(c=c.substring(0,c.length-1)),s.emit("response",c)}}else s.hasAuthed=!0,s.emit("auth");else s.emit("error",new Error("Authentication failed"));t=t.slice(12+e-8)}},s.socketOnConnect=function(){if(s.emit("connect"),s.tcp)s.send(s.password,3);else if(s.challenge){var t="challenge rcon\n",e=o.Buffer.alloc(t.length+4);e.writeInt32LE(-1,0),e.write(t,4),s._sendSocket(e)}else{var n=o.Buffer.alloc(5);n.writeInt32LE(-1,0),n.writeUInt8(0,4),s._sendSocket(n),s.hasAuthed=!0,s.emit("auth")}},s.socketOnEnd=function(){s.emit("end"),s.hasAuthed=!1},u=u||{},s.host=r,s.port=i,s.password=a,s.rconId=u.id||1234086,s.hasAuthed=!1,s.outstandingData=null,s.tcp=!u.tcp||u.tcp,s.challenge=!u.challenge||u.challenge,s._challengeToken="",t.EventEmitter.call(function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(s)),s}return a=c,(i=u).prototype=Object.create(a.prototype),i.prototype.constructor=i,r(i,a),u}(t.EventEmitter);
//# sourceMappingURL=ts-rcon.cjs.production.min.js.map
